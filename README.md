# Simple wall extraction

Прототип для извлечения геометрии стен из изображений планов помещений и предоставления результата в виде JSON.

---

### Входные данные
- Изображения планов помещений
---
### Выходные данные
- JSON-файл со стенами:
```json
{
  "meta": { "source": "input_image.png" },
  "walls": [
    { "id": "w1", "points": [[x1, y1], [x2, y2], [x3, y3]] },
    { "id": "w2", "points": [[x1, y1], [x2, y2]] }
  ]
}
```
- Визуальный оверлей (*_overlay.png) с наложенными стенами для проверки результата

---
## Этапы пайплайна

### Предобработка

- преобразование изображения в grayscale;

- гаусово сглаживание для подавления шума

- бинаризация чертежа с помощью адаптивного порога

- инверсия изображения, чтобы линии и заливки стали передним фоном

- erode и dilate для удаления посторонних(тонких и мелких) объектов с кадра

### Выделение контуров
- получаем контуры по получившейся маске с помощью findContours

- фильтруем контуры по размеру и форме

### Экспорт и визуализация

- сохранение результата в JSON;

- построение оверлея поверх исходного изображения.

## Используемые инструменты
Модуль был написан с использованием классических CV методов с помощью библиотеки opencv. Данное решение было принято ввиду:
- отсутствия требований к сбору и обучени моделей(если использовать нейронные сети или гибридные методы)
- достаточно прозрачен и понятен каждый шаг
- быстрый и воспроизводимый прототип для тестового задания
  
## Слабые места
Выбор использования классического CV привёл с собой и некоторые ограничения.
- Качество результата зависит от графического стиля плана. Так например, на 1.png присутствовала рамка по контуру кадра и модуль определил всю её как один контур, при обрезке стены обнаружились нормально(1_crop.png). В предоставленном кадре 8.png стены полые и никак не выделяются на фоне остальной структуры плана поэтому выделить их не удалось
- В данном решении отсутствует определение дверей/окон и помещений, поскольку всё также сильно зависит от структур плана

## Возможные улучшения
Я вижу данную систему, состоящую из трёх частей.
### Стены
Определение стен будет реализовано с использованием моделей семантической сегментации(UNet/DeepLab). Подобные решения уже достаточно долго практикуются и показывают себя достаточно хорошо, обобщаясь на большом количестве планов и видов стен. Проблема заключается в сборе датасета и его разметке. Далее результат обрабатывается и приводится в более геометрически верный вид
### Двери/окна, мебель
За определение дверей, окон и возможно мебели(если рассматривать расширение) будет отвечать модель детекции объектов(YOLO/Faster R-CNN). Так как присутствует разное количество видов окон и дверей, то наше решение должно быть масштабируемо и адаптируемо, поэтому мы разделили элементы интерьера от семантики стен. 
### Постпроцессинг 
Получив маски стен и объекты с детектора, объединим их для получения общей картины плана. На этом этапе можем выделить полигоны помещений и иметь готовый план
### OCR
Для распознавания возможных текстов и размеров предполагаю реализацию с использованием E2E-MLT

## Как запустить

Собрать образ:

```bash
docker build . -t plans
```
Работу модуля можно проверить данной командой:
```
docker run -v "$PWD:/work" -w /work plans --img_path 1.png --json_path data/.json --overlay_path examples/overlay.png
```
Также можно запустить просто как питон скрипт через plan.py предварительно установив зависимости
